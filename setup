#!/bin/bash

set -e
touch ~/.bash_profile
# Ensure bash profile exists for nvm installer
if [[ "$SHELL" == *"bash"* ]] && [ ! -f "$HOME/.bash_profile" ]; then
    echo "Creating ~/.bash_profile for bash shell..."
    touch "$HOME/.bash_profile"
fi

echo "Installing nvm..."
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash

echo "Loading nvm..."
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Also try to source from shell config files in case nvm was added there
if [[ "$SHELL" == *"zsh"* ]]; then
    echo "Detected zsh shell, sourcing ~/.zshrc if it exists..."
    [ -s "$HOME/.zshrc" ] && source "$HOME/.zshrc"
elif [[ "$SHELL" == *"bash"* ]]; then
    echo "Detected bash shell, sourcing ~/.bash_profile if it exists..."
    [ -s "$HOME/.bash_profile" ] && source "$HOME/.bash_profile"
    [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
fi

if ! command -v nvm &> /dev/null; then
    echo "Error: nvm not found after installation. Please restart your terminal and run this script again."
    exit 1
fi

echo "Installing Node.js v22..."
nvm install 22
nvm alias default 22
nvm use 22

echo "Installing npm dependencies..."
npm install
source ~/.bash_profile

echo "Setup complete! Node.js $(node --version) is now installed and ready to use."
echo "Now run: source ~/.bash_profile"
